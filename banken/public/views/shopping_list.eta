<!DOCTYPE html>
<html lang="en" data-theme="cupcake">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>
    Shopping List | My Recipe Collection
  </title>
  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- DaisyUI -->
  <link href="https://cdn.jsdelivr.net/npm/daisyui@3.9.4/dist/full.css" rel="stylesheet" type="text/css" />
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Alpine.js for reactivity -->
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <script src="../js/redirect.js"></script>
</head>

<% function formatDate(dateStr) {
    const dateOnly = dateStr.split("T")[0];
    const date = new Date(dateOnly);
    return date.toLocaleDateString('en-US', {
        month: 'long',
        day: 'numeric',
        year: 'numeric'
    });
  }
%>

<% function idToName(id) {
    const author = it.list.author
    const contributorList = it.list.contributors
    if (id === author.user_id) return author.username

    for (const contributor of contributorList) {
      if (id === contributor.user_id) return contributor.username
    }
  }
%>

<% function isContributor(username) {
    const contributorList = it.list.contributors
    for (const contributor of contributorList) {
      if (username === contributor.username) return true
    }
  }
%>

<body class="min-h-screen flex flex-col">
  <%~ include("./partials/nav", it) %>

  <div class="container mx-auto px-4 py-8 max-w-4xl">
    <!-- Header with list info -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
      <div class="flex justify-between items-start mb-4">
        <div>
          <h1 class="text-3xl font-bold text-gray-800" id="list-title"><%= it.list.list_name %></h1>
          <p class="text-gray-600">
            Created by <span class="font-semibold" id="author-name"><%= it.list.author.username %></span>
            on <span id="created-date"><%= formatDate(it.list.created_at)%></span>
          </p>
        </div>
        <div class="badge badge-lg badge-primary" id="item-count">
          <i class="fas fa-shopping-basket mr-1"></i>
          <span><%= it.list.total_items %> items</span>
        </div>
      </div>

      <!-- Contributors section -->
      <div class="mt-4">
        <h3 class="text-sm font-semibold text-gray-500 mb-2">Shared With</h3>
        <div class="flex flex-wrap gap-2" id="contributors-list">
          <% it.list.contributors.forEach(function(contributor) { %>
          <div class="badge badge-outline">
            <i class="fas fa-user mr-1"></i> <%= contributor.username %>
          </div>
          <% }) %>
        </div>
      </div>
    </div>

    <!-- Shopping list items -->
    <div class="bg-white rounded-lg shadow-md overflow-visible">
      <div class="divide-y divide-gray-200">
        <!-- Category header (optional) -->
        <div class="px-6 py-3 bg-gray-100">
          <h3 class="font-medium text-gray-700">
            <i class="fas fa-utensils mr-2"></i> Items
          </h3>
        </div>

        <!-- List items -->
        <div id="shopping-items">
          <% it.list.items.forEach(function(item) { %>
          <div class="shopping-item px-6 py-4 flex items-center hover:bg-gray-50">
            <div class="flex items-center mr-4 ">
              <input type="checkbox" class="checkbox checkbox-primary" <%= item.is_checked ? 'checked' : ''%> />
            </div>
            <div class="flex-grow">
              <div class="item-name font-medium text-gray-800"><%= item.item_name%></div>
              <div class="text-sm text-gray-500"><%= item.quantity%> <%= item.unit ? item.unit : ''%></div>
            </div>
            <div class="text-sm text-gray-500 ml-4">
              Added by <span class="font-medium added-by"><%= idToName(item.added_by) %></span>
            </div>
            <button class="ml-4 text-gray-400 hover:text-gray-600 remove-item">
              <i class="fas fa-trash"></i>
            </button>
          </div>
          <% }) %>

        </div>

        <!-- Add new item -->
        <div class="px-6 py-4 bg-gray-50">
          <div class="flex items-center relative" x-data="shoppingListAutocomplete()">
            <button class="btn btn-sm btn-ghost mr-2" @click="addItemToList()">
              <i class="fas fa-plus"></i>
            </button>

            <!-- Input with autocomplete -->
            <div class="relative w-full max-w-xs">
              <input type="text" placeholder="Add new item..." class="input input-bordered input-sm w-full" x-model="query" @input.debounce.300ms="filterItems" @focus="open = true" @keydown.escape="open = false" @keydown.arrow-down.prevent="moveDown" @keydown.arrow-up.prevent="moveUp" @keydown.enter.prevent="selectItem" />

              <!-- Dropdown menu -->
              <ul x-show="open && matches.length" x-cloak @click.outside="open = false" class="absolute left-0 right-0 mt-1 w-full bg-white shadow-lg rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto max-h-60 focus:outline-none sm:text-sm z-50" x-transition:enter="transition ease-out duration-100" x-transition:enter-start="transform opacity-0 scale-95" x-transition:enter-end="transform opacity-100 scale-100" x-transition:leave="transition ease-in duration-75" x-transition:leave-start="transform opacity-100 scale-100" x-transition:leave-end="transform opacity-0 scale-95">
                <template x-for="(item, index) in matches" :key="index">
                  <li>
                    <a @click="selectItemWithClick(index)" :class="{ 'bg-primary text-white': index === activeIndex }" class="cursor-default select-none relative py-2 pl-3 pr-9 hover:bg-primary hover:text-white block truncate" x-text="item"></a>
                  </li>
                </template>
              </ul>
            </div>

            <!-- Quantity Input -->
            <div class="form-control w-20">
              <input type="number" min="1" value="1" class="input input-bordered input-sm" x-model="quantity" placeholder="Qty">
            </div>

            <!-- Unit Input -->
            <div class="form-control w-24">
              <input type="text" class="input input-bordered input-sm" x-model="unit" placeholder="Unit">
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- List actions -->
    <div class="mt-6 flex justify-end space-x-3">
      <% if (it.isAuthor) {%>
      <button class="btn btn-outline btn-sm" onclick="document.getElementById('my_modal').showModal()">
        <i class="fas fa-share-alt mr-2"></i> Share
      </button>
      <% } %>
      <button class="btn btn-error btn-sm">
        <i class="fas fa-trash mr-2"></i> Delete
      </button>
      <button class="btn btn-primary btn-sm">
        <i class="fas fa-save mr-2"></i> Save Changes
      </button>
    </div>
  </div>

  <% if (it.isAuthor) { %>
  <!-- Modal -->
  <dialog id="my_modal" class="modal">
    <div class="modal-box">
      <form method="dialog">
        <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2">
          <i class="fas fa-times"></i>
        </button>
      </form>

      <h3 class="font-bold text-lg mb-4">
        <i class="fas fa-users mr-2"></i>User Assignment
      </h3>

      <form id="assignmentForm" class="space-y-4" action="/api/list/shareList" method="POST">
        <!-- Hidden field for list ID -->
        <input type="hidden" id="listId" name="listId" value="<%= it.listId%>">

        <!-- Dropdown for usernames -->
        <div class="form-control w-full">
          <label class="label" for="username">
            <span class="label-text">
              <i class="fas fa-user mr-2"></i>Select User
            </span>
          </label>
          <select id="username" name="username" class="select select-bordered w-full" required>
            <option disabled selected>Choose a user</option>
            <% it.usernames.forEach((user) => {%>
            <option value="<%= user.username%>">
              <%= user.username%><%= isContributor(user.username) ? ' âœ“' : '' %>
            </option>
            <%})%>
          </select>
        </div>

        <!-- Form actions -->
        <div class="modal-action">
          <button type="button" onclick="document.getElementById('my_modal').close()" class="btn btn-ghost">
            <i class="fas fa-times mr-2"></i> Cancel
          </button>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-check mr-2"></i> Submit
          </button>
        </div>
      </form>
    </div>

    <!-- Click outside to close -->
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>
  <% } %>

  <%~ include("./partials/footer") %>
  <script src="../js/listItems.js"></script>
  <script>
    window.itemNames = <%~ JSON.stringify(it.itemNames)%>;
    window.currentUsername = <%~JSON.stringify(it.currentUsername)%>;
  </script>
</body>

</html>